'use strict';
angular.module('app')
.controller('alarmManageCtrl',['$filter','$rootScope','$scope','$http','$state','$timeout','toaster','$stateParams','$interval','yxRequest','yxLogin','yxLocalStorage','$sce',
function($filter,$rootScope,$scope,$http,$state,$timeout,toaster,$stateParams,$interval,yxRequest,yxLogin,yxLocalStorage,$sce){
$(".dataPicker_startTime").datetimepicker({
timeText:'时间',
hourText:'小时',
minuteText:'分钟',
secondText:'秒',
currentText:'现在',
closeText:'完成',
showSecond:true,
dateFormat:'yy-mm-dd',
timeFormat:'HH:mm:ss'
});
$(".dataPicker_endTime").datetimepicker({
timeText:'时间',
hourText:'小时',
minuteText:'分钟',
secondText:'秒',
currentText:'现在',
closeText:'完成',
showSecond:true,
dateFormat:'yy-mm-dd',
timeFormat:'HH:mm:ss'
});
$scope.param={};
$scope.datatimechanged=function(){
console.log($scope.param)
}
$rootScope.defaultTime($scope.param,1);
$scope.getAlarmList=function(){
$scope.searching=true;
yxRequest.send('post',yxIp.requestIp+'gl/get_alarm',
$scope.param,
function(result){
$scope.searching=false;
$scope.alarmList=result;
angular.forEach($scope.alarmList.data,function(v,k){
let res=$rootScope.dictionaryMsg.YaoXin.filter(function(v1,k1){
return v1.Address==v.Address
});
if(res.length==1){
v.alarmPoint=res[0].Description
}else{
yxLocalStorage.arrAdd({type:'error',msg:'告警管理列表获取的address与点表不对应或对应多个，address:'+v.Address,time:new Date()});
}
})
$scope.pageInfo={};
$scope.pageInfo.row=10;
$scope.pageInfo.total=$scope.alarmList.data.length;
$scope.pagination(1)
if($scope.alarmList.data.length==1000){
toaster.pop('warning','','最多查询1000条数据，可能会有数据丢失，请缩小日期区间！')
}
},function(data){
$scope.searching=false;
yxLocalStorage.arrAdd({type:'error',msg:data,time:new Date()})
if(global_level>1){
console.log('获取告警管理列表失败',data);
}
toaster.pop('error','',data.msg)
}
);
}
$scope.getAlarmList();
$scope.pagination=function(pageNum){
$scope.pageInfo.data=$scope.alarmList.data.slice($scope.pageInfo.row*(pageNum-1),$scope.pageInfo.row*pageNum);
$scope.pageInfo.pageNum=pageNum;
$scope.pageInfo.size=$scope.pageInfo.data.length;
}
$scope.quickSearch=function(){
$rootScope.defaultTime($scope.param,$scope.days);
$('.dataPicker_startTime').datetimepicker('setDate',($scope.param.start_time));
$('.dataPicker_endTime').datetimepicker('setDate',($scope.param.end_time));
}
$scope.alarmManageFun=function(){}
$scope.listExport=function(){
let obj={title:['动作时间','事件信息','状态','时长（ms）','数值'],data:[]};
angular.forEach($scope.alarmList.data,function(v,k){
let subArr=[];
subArr.push(v.Time,v.alarmPoint,v.State,v.Duration,v.WarnValue);
obj.data.push(subArr)
})
$rootScope.listExport(obj)
}
}]);